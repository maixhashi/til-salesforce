# Salesforceオブジェクト間の関連性を理解する方法

## What's this file?
> [!NOTE]
> **How**
> 
> どのようにSalesforceの各オブジェクト間の関連性を理解し、完全な関係図を構築するかについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **How** : どのようにオブジェクト間の関連性を理解するか
> 
> **Answer** : Salesforceの主要オブジェクトは参照関係（ルックアップ）と主従関係でつながり、Account（取引先）を中心にContact、Opportunity、Caseなどがツリー構造を形成し、UserとActivityが横断的に関連する

## 目次

<details>
<summary>目次を開く</summary>

- [オブジェクト関係の基本概念](#オブジェクト関係の基本概念)
- [コアオブジェクトの関係図](#コアオブジェクトの関係図)
- [セールス系オブジェクトの関係](#セールス系オブジェクトの関係)
- [サービス系オブジェクトの関係](#サービス系オブジェクトの関係)
- [共通オブジェクトとの関係](#共通オブジェクトとの関係)
- [複雑な関係パターンの理解](#複雑な関係パターンの理解)

</details>

## オブジェクト関係の基本概念

### リレーションシップの種類

```mermaid
flowchart TD
    A[リレーションシップ] --> B[参照関係<br/>Lookup]
    A --> C[主従関係<br/>Master-Detail]
    A --> D[多対多関係<br/>Junction Object]
    
    B --> E[削除時：関連なし<br/>所有者：独立<br/>ロールアップ：不可]
    C --> F[削除時：カスケード<br/>所有者：継承<br/>ロールアップ：可]
    D --> G[中間オブジェクト使用<br/>柔軟な関連付け]
    
    style B fill:#99ccff
    style C fill:#ff9999
    style D fill:#ccffcc
```

### リレーションシップの特性比較

| 特性 | 参照関係（Lookup） | 主従関係（Master-Detail） | 階層関係 |
|------|-------------------|-------------------------|----------|
| **必須項目** | 任意設定可能 | 常に必須 | 任意 |
| **親削除時** | 子は残る | 子も削除 | 制限あり |
| **共有設定** | 独立 | 親から継承 | 独立 |
| **ロールアップ集計** | 不可 | 可能 | 不可 |
| **親の変更** | 可能 | 条件付き可能 | 可能 |

### 関係の基数（カーディナリティ）

```yaml
1対1の関係:
  例: User ←→ UserDetail
  実装: 片方にユニークな参照項目
  
1対多の関係:
  例: Account ←→ Contact
  実装: 子に親への参照項目
  
多対多の関係:
  例: Contact ←→ Campaign
  実装: CampaignMember（中間オブジェクト）
```

## コアオブジェクトの関係図

### 中心的なオブジェクト関係

```mermaid
flowchart TD
    User[User<br/>ユーザー] --> |所有| Account[Account<br/>取引先]
    User --> |所有| Contact[Contact<br/>取引先責任者]
    User --> |所有| Lead[Lead<br/>リード]
    
    Account --> |1対多| Contact
    Account --> |1対多| Opportunity[Opportunity<br/>商談]
    Account --> |1対多| Case[Case<br/>ケース]
    Account --> |1対多| Contract[Contract<br/>契約]
    
    Contact --> |多対多| Campaign[Campaign<br/>キャンペーン]
    Contact --> |1対多| Case
    Contact --> |関連| Opportunity
    
    Opportunity --> |1対多| Quote[Quote<br/>見積]
    Opportunity --> |1対多| OpportunityLineItem[商談商品]
    
    Product2[Product2<br/>商品] --> |多対多| PricebookEntry[価格表エントリ]
    PricebookEntry --> OpportunityLineItem
    
    style Account fill:#ffcc99
    style User fill:#99ff99
```

### Account中心の関係性

```mermaid
flowchart LR
    Account[Account<br/>取引先] --> Contact[Contact<br/>取引先責任者]
    Account --> Opportunity[Opportunity<br/>商談]
    Account --> Case[Case<br/>ケース]
    Account --> Contract[Contract<br/>契約]
    Account --> Asset[Asset<br/>資産]
    Account --> Order[Order<br/>注文]
    
    Account --> |親子関係| Account2[子取引先]
    
    Contact --> Case
    Contact --> Opportunity
    Contact --> Task[Task/Event<br/>活動]
    
    Opportunity --> Quote[Quote<br/>見積]
    Opportunity --> Order
    
    Case --> Task
    
    style Account fill:#ff9999
```

## セールス系オブジェクトの関係

### リードから商談への変換フロー

```mermaid
flowchart TD
    Lead[Lead<br/>リード] --> |変換| A{変換プロセス}
    
    A --> Account[Account<br/>取引先]
    A --> Contact[Contact<br/>取引先責任者]
    A --> Opportunity[Opportunity<br/>商談]
    
    Campaign[Campaign<br/>キャンペーン] --> |メンバー| Lead
    Campaign --> |メンバー| Contact
    
    Opportunity --> OpportunityContactRole[商談の<br/>取引先責任者の役割]
    Contact --> OpportunityContactRole
    
    Opportunity --> OpportunityLineItem[商談商品]
    Product2[商品] --> PricebookEntry[価格表エントリ]
    PricebookEntry --> OpportunityLineItem
    
    Opportunity --> Quote[見積]
    Quote --> QuoteLineItem[見積品目]
    
    style Lead fill:#ccffcc
    style A fill:#ffffcc
```

### 商品と価格の関係

```mermaid
flowchart TD
    Product2[Product2<br/>商品マスタ] --> PricebookEntry[PricebookEntry<br/>価格表エントリ]
    Pricebook2[Pricebook2<br/>価格表] --> PricebookEntry
    
    PricebookEntry --> |標準価格| StandardPrice[標準価格表]
    PricebookEntry --> |カスタム価格| CustomPrice[カスタム価格表]
    
    PricebookEntry --> OpportunityLineItem[OpportunityLineItem<br/>商談商品]
    PricebookEntry --> QuoteLineItem[QuoteLineItem<br/>見積品目]
    PricebookEntry --> OrderItem[OrderItem<br/>注文商品]
    
    Opportunity --> OpportunityLineItem
    Quote --> QuoteLineItem
    Order --> OrderItem
    
    style Product2 fill:#99ccff
    style Pricebook2 fill:#ffcc99
```

## サービス系オブジェクトの関係

### ケース管理の関係図

```mermaid
flowchart TD
    Case[Case<br/>ケース] --> Account[Account<br/>取引先]
    Case --> Contact[Contact<br/>取引先責任者]
    Case --> Asset[Asset<br/>資産]
    
    Case --> CaseComment[CaseComment<br/>ケースコメント]
    Case --> CaseHistory[CaseHistory<br/>ケース履歴]
    Case --> EmailMessage[EmailMessage<br/>メール]
    
    Case --> |親子| Case2[関連ケース]
    
    Entitlement[Entitlement<br/>エンタイトルメント] --> Case
    ServiceContract[ServiceContract<br/>サービス契約] --> Entitlement
    Account --> ServiceContract
    
    Solution[Solution<br/>ソリューション] --> |多対多| Case
    
    CaseTeamMember[ケースチームメンバー] --> Case
    User --> CaseTeamMember
    
    style Case fill:#99ccff
```

### 資産とサービス契約

```mermaid
flowchart LR
    Account[Account] --> Asset[Asset<br/>資産]
    Product2[Product2] --> Asset
    
    Asset --> Case[Case]
    Asset --> ServiceContract[ServiceContract<br/>サービス契約]
    
    ServiceContract --> ContractLineItem[契約品目]
    ServiceContract --> Entitlement[Entitlement<br/>エンタイトルメント]
    
    Entitlement --> Case
    Entitlement --> EntitlementContact[エンタイトルメント<br/>取引先責任者]
    
    Contact --> EntitlementContact
    
    style Asset fill:#ccffcc
```

## 共通オブジェクトとの関係

### 活動（Task/Event）の関係

```mermaid
flowchart TD
    Activity[活動] --> Task[Task<br/>ToDo]
    Activity --> Event[Event<br/>行動]
    
    Task --> |WhatId| A[ポリモーフィック<br/>関連先]
    Event --> |WhatId| A
    
    A --> Account
    A --> Opportunity
    A --> Case
    A --> Campaign
    A --> Custom[カスタムオブジェクト]
    
    Task --> |WhoId| B[ポリモーフィック<br/>名前]
    Event --> |WhoId| B
    
    B --> Contact
    B --> Lead
    
    User[User<br/>所有者] --> Task
    User --> Event
    
    style Activity fill:#ffffcc
```

### 添付ファイルとコンテンツ

```mermaid
flowchart TD
    Parent[親レコード] --> Attachment[Attachment<br/>旧添付ファイル]
    Parent --> ContentDocumentLink[ContentDocumentLink<br/>コンテンツリンク]
    
    ContentDocumentLink --> ContentDocument[ContentDocument<br/>コンテンツ文書]
    ContentDocument --> ContentVersion[ContentVersion<br/>バージョン管理]
    
    Parent --> Note[Note<br/>旧メモ]
    Parent --> ContentNote[ContentNote<br/>拡張メモ]
    
    FeedItem[Chatterフィード] --> ContentDocument
    
    Parent --> |どのオブジェクトでも| Files[ファイル]
    
    style ContentDocument fill:#99ff99
```

## 複雑な関係パターンの理解

### 多対多関係の実装パターン

```mermaid
flowchart TD
    subgraph "標準の多対多"
        Contact1[Contact] --> CampaignMember[CampaignMember<br/>中間オブジェクト]
        Campaign1[Campaign] --> CampaignMember
    end
    
    subgraph "カスタム多対多"
        Student[Student__c] --> Enrollment[Enrollment__c<br/>履修]
        Course[Course__c] --> Enrollment
        Enrollment --> Grade[成績情報]
    end
    
    subgraph "自己参照多対多"
        Account1[Account] --> AccountPartner[AccountPartner<br/>パートナー]
        Account2[Account] --> AccountPartner
    end
```

### 階層的な関係

```yaml
取引先階層:
  親取引先:
    - 最上位の持株会社
    - ParentId = null
    
  子会社:
    - ParentId = 親取引先ID
    - 最大5階層まで推奨
    
  関連項目:
    - Ultimate Parent（最上位親）
    - 階層ロールアップ

キャンペーン階層:
  年間計画:
    - 最上位キャンペーン
    
  四半期キャンペーン:
    - Parent Campaign = 年間計画
    
  個別施策:
    - Parent Campaign = 四半期
    - 統計情報の自動集計
```

### 共有とアクセス権の関係

```mermaid
flowchart TD
    OWD[組織の共有設定] --> Record[レコード]
    
    Role[ロール階層] --> Record
    SharingRule[共有ルール] --> Record
    ManualShare[手動共有] --> Record
    TeamMember[チームメンバー] --> Record
    
    Record --> |アクセスレベル| User[ユーザー]
    
    Owner[所有者] --> |フルアクセス| Record
    
    Profile[プロファイル] --> |オブジェクト権限| Record
    PermissionSet[権限セット] --> |追加権限| Record
    
    style OWD fill:#ff9999
    style Record fill:#99ccff
```

### 承認プロセスとの関係

```mermaid
flowchart LR
    Record[レコード] --> ApprovalProcess[承認プロセス]
    
    ApprovalProcess --> ProcessInstance[プロセスインスタンス]
    ProcessInstance --> ProcessInstanceStep[承認ステップ]
    ProcessInstanceStep --> ProcessInstanceWorkitem[承認申請]
    
    User1[申請者] --> ProcessInstance
    User2[承認者] --> ProcessInstanceWorkitem
    
    ProcessInstanceWorkitem --> |承認/却下| ProcessInstanceStep2[次のステップ]
    
    Record --> |項目更新| FinalApproval[最終承認アクション]
    
    style ApprovalProcess fill:#ccffcc
```

### システム全体の関係俯瞰図

```mermaid
flowchart TD
    subgraph "ユーザーと権限"
        User[User] --> Profile[Profile]
        User --> Role[Role]
        User --> PermissionSet[Permission Set]
    end
    
    subgraph "顧客管理"
        Account[Account] --> Contact[Contact]
        Lead[Lead] -.-> |変換| Account
        Lead -.-> |変換| Contact
    end
    
    subgraph "営業管理"
        Account --> Opportunity[Opportunity]
        Contact --> Opportunity
        Opportunity --> Quote[Quote]
        Product[Product2] --> Opportunity
    end
    
    subgraph "サービス管理"
        Account --> Case[Case]
        Contact --> Case
        Asset[Asset] --> Case
    end
    
    subgraph "マーケティング"
        Campaign[Campaign] --> Lead
        Campaign --> Contact
    end
    
    subgraph "共通"
        User --> |所有| Account
        User --> |所有| Opportunity
        User --> |所有| Case
        Task[Task/Event] --> Account
        Task --> Contact
        Task --> Opportunity
    end
    
    style Account fill:#ff9999
    style User fill:#99ff99
    style Opportunity fill:#ffffcc
```

## 関連

- [Salesforceの標準オブジェクトとレコード種別](2025.08.12.22.03_what_salesforce_standard_objects_by_records.md)
- [Salesforceのキャンペーン関連オブジェクト](2025.08.12.22.09_what_salesforce_campaign_related_objects.md)
- [Salesforceのケースチームとは](2025.08.12.21.54_what_salesforce_case_team.md)
- [Salesforce Help: オブジェクトリレーションシップの概要](https://help.salesforce.com/s/articleView?id=sf.overview_of_custom_object_relationships.htm&type=5)
- [Salesforce Developer: ERD（Entity Relationship Diagrams）](https://developer.salesforce.com/docs/atlas.en-us.api.meta/api/data_model.htm)
- [Trailhead: データモデリング](https://trailhead.salesforce.com/ja/content/learn/modules/data_modeling)