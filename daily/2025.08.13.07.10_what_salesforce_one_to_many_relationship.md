# Salesforceの1対多関係

## What's this file?
> [!NOTE]
> **What**
> 
> Salesforceの1対多関係とは何かについて記載しています。

## Conclusion (忙しいとき向け)
> [!IMPORTANT]
> **What** : 1対多関係とは何か
> 
> **Answer** : 親オブジェクトの1つのレコードに対して、子オブジェクトの複数のレコードが関連付けられる関係で、Salesforceでは参照関係（Lookup）または主従関係（Master-Detail）として実装される基本的なデータモデルパターン

## 目次

<details>
<summary>目次を開く</summary>

- [1対多関係の基本概念](#1対多関係の基本概念)
- [参照関係による1対多の実装](#参照関係による1対多の実装)
- [主従関係による1対多の実装](#主従関係による1対多の実装)
- [標準オブジェクトでの1対多関係の例](#標準オブジェクトでの1対多関係の例)
- [1対多関係の設計パターン](#1対多関係の設計パターン)
- [UI上での1対多関係の表示](#ui上での1対多関係の表示)

</details>

## 1対多関係の基本概念

### 1対多関係とは

```mermaid
flowchart TD
    A[親オブジェクト<br/>1レコード] --> B[子オブジェクト<br/>複数レコード]
    
    A --> C[取引先<br/>ABC商事]
    
    C --> D[取引先責任者<br/>田中太郎]
    C --> E[取引先責任者<br/>佐藤花子]
    C --> F[取引先責任者<br/>鈴木一郎]
    
    C --> G[商談<br/>新規案件A]
    C --> H[商談<br/>更新案件B]
    
    C --> I[ケース<br/>問い合わせ#1]
    C --> J[ケース<br/>問い合わせ#2]
    
    style A fill:#ff9999
    style C fill:#ffcc99
    style D,E,F fill:#99ccff
    style G,H fill:#ccffcc
    style I,J fill:#ffccff
```

### データベース観点での理解

```yaml
リレーショナルデータベースの概念:
  親テーブル（1側）:
    - プライマリキー（Id）を持つ
    - 1つのレコードが存在
    
  子テーブル（多側）:
    - 外部キー（親のId参照）を持つ
    - 複数レコードが同じ親を参照可能
    
Salesforceでの実装:
  親オブジェクト:
    - 通常のレコード
    - 子の存在を知らない（直接的には）
    
  子オブジェクト:
    - 親への参照項目を持つ
    - 項目タイプ：Lookup または Master-Detail
```

### 1対多関係の特徴

| 特徴 | 説明 | 例 |
|------|------|-----|
| **方向性** | 子から親への単方向参照 | Contact → Account |
| **カーディナリティ** | 1つの親に0〜多数の子 | 1取引先に複数商談 |
| **必須性** | 実装方法により異なる | Lookup：任意、Master-Detail：必須 |
| **削除動作** | 実装方法により異なる | 親削除時の子の扱い |

## 参照関係による1対多の実装

### Lookup（参照関係）の特性

```mermaid
flowchart LR
    A[Lookup関係] --> B[特性]
    
    B --> C[任意項目可]
    B --> D[独立した共有設定]
    B --> E[親削除時も子は残る]
    B --> F[親の変更可能]
    
    C --> G[子は親なしで存在可能]
    D --> H[親子で異なる共有ルール]
    E --> I[孤児レコードの可能性]
    F --> J[再親子付けが柔軟]
    
    style A fill:#99ccff
    style B fill:#ccffcc
```

### Lookupの実装例

```yaml
Case（ケース）オブジェクトの例:
  AccountId項目:
    型: Lookup(Account)
    必須: false
    説明: 関連する取引先
    
  ContactId項目:
    型: Lookup(Contact)
    必須: false
    説明: 関連する取引先責任者
    
動作:
  - Caseは取引先なしでも作成可能
  - 取引先を削除してもCaseは残る
  - Caseの取引先を後から変更可能
```

### Lookupの設定画面

```mermaid
flowchart TD
    A[オブジェクトマネージャ] --> B[子オブジェクト選択]
    B --> C[項目とリレーション]
    C --> D[新規 → 参照関係]
    
    D --> E[関連先オブジェクト選択]
    E --> F[項目の詳細設定]
    
    F --> G[項目ラベル]
    F --> H[項目名（API）]
    F --> I[必須設定]
    F --> J[ヘルプテキスト]
    
    E --> K[親オブジェクト選択<br/>例：Account]
    
    style D fill:#ffcc99
```

## 主従関係による1対多の実装

### Master-Detail（主従関係）の特性

```mermaid
flowchart LR
    A[Master-Detail関係] --> B[特性]
    
    B --> C[必須項目]
    B --> D[共有設定継承]
    B --> E[カスケード削除]
    B --> F[ロールアップ集計]
    
    C --> G[子は必ず親を持つ]
    D --> H[親の共有設定を継承]
    E --> I[親削除で子も削除]
    F --> J[親で子の集計可能]
    
    A --> K[制限事項]
    K --> L[親の変更制限]
    K --> M[最大2つまで]
    
    style A fill:#ff9999
    style B fill:#ccffcc
```

### Master-Detailの実装例

```yaml
OpportunityLineItem（商談商品）の例:
  OpportunityId項目:
    型: Master-Detail(Opportunity)
    必須: true（自動）
    説明: 親商談への参照
    
特別な機能:
  ロールアップ集計項目:
    - 商談の合計金額
    - 商品数のカウント
    - 最高価格商品
    - 最低価格商品
    
動作:
  - 商談なしでは商品追加不可
  - 商談削除で全商品も削除
  - 商談の共有設定を継承
```

### Master-DetailとLookupの比較

| 機能 | Lookup（参照） | Master-Detail（主従） |
|------|---------------|---------------------|
| **必須性** | 任意設定可能 | 常に必須 |
| **親の削除** | 子は残る | 子も削除（カスケード） |
| **共有設定** | 独立 | 親から継承 |
| **親の変更** | 可能 | 制限あり |
| **ロールアップ** | 不可 | 可能 |
| **レコード所有者** | 独自の所有者 | 親の所有者を継承 |

## 標準オブジェクトでの1対多関係の例

### 典型的な1対多関係

```mermaid
flowchart TD
    subgraph "取引先中心の1対多"
        Account[Account<br/>取引先] --> Contact[Contact<br/>取引先責任者]
        Account --> Opportunity[Opportunity<br/>商談]
        Account --> Case[Case<br/>ケース]
        Account --> Contract[Contract<br/>契約]
    end
    
    subgraph "商談の1対多"
        Opportunity --> Quote[Quote<br/>見積]
        Opportunity --> OpportunityLineItem[商談商品]
        Opportunity --> OpportunityContactRole[商談の役割]
    end
    
    subgraph "ケースの1対多"
        Case --> CaseComment[ケースコメント]
        Case --> EmailMessage[メール]
        Case --> Task[活動]
    end
    
    style Account fill:#ff9999
    style Opportunity fill:#ffcc99
    style Case fill:#99ccff
```

### 実際の使用例

```yaml
営業プロセスでの1対多:
  Account（取引先）:
    → Contact（取引先責任者）: 
      - 複数の担当者
      - 意思決定者、技術担当など
      
    → Opportunity（商談）:
      - 新規案件
      - 追加案件
      - 更新案件
      
カスタマーサービスでの1対多:
  Account（取引先）:
    → Case（ケース）:
      - 問い合わせ履歴
      - サポート案件
      - クレーム対応
      
    → Asset（資産）:
      - 購入製品
      - ライセンス
      - サービス契約
```

## 1対多関係の設計パターン

### 設計時の考慮事項

```mermaid
flowchart TD
    A[設計検討] --> B{削除時の動作}
    
    B -->|子も削除したい| C[Master-Detail]
    B -->|子を残したい| D[Lookup]
    
    A --> E{共有設定}
    E -->|親と同じ| C
    E -->|独立管理| D
    
    A --> F{集計要件}
    F -->|ロールアップ必要| C
    F -->|不要| D
    
    A --> G{必須性}
    G -->|親は必須| C
    G -->|親は任意| D
    
    style A fill:#ccffcc
    style C fill:#ff9999
    style D fill:#99ccff
```

### ベストプラクティス

```yaml
命名規則:
  項目名:
    - 親オブジェクト名 + Id
    - 例：AccountId, OpportunityId
    
  表示ラベル:
    - 日本語で分かりやすく
    - 例：取引先、関連商談
    
パフォーマンス考慮:
  インデックス:
    - Lookup項目は自動インデックス
    - 検索性能の向上
    
  制限事項:
    - 1オブジェクトに40個まで
    - Master-Detailは2個まで
    
データ品質:
  検証ルール:
    - 親子の整合性チェック
    - ビジネスルールの実装
```

### カスタムオブジェクトでの実装例

```mermaid
flowchart LR
    A[Project__c<br/>プロジェクト] --> B[Task__c<br/>タスク]
    A --> C[Milestone__c<br/>マイルストーン]
    
    D[Employee__c<br/>従業員] --> E[Timesheet__c<br/>勤怠]
    D --> F[Expense__c<br/>経費]
    
    G[Product__c<br/>製品] --> H[Component__c<br/>部品]
    G --> I[Review__c<br/>レビュー]
    
    style A,D,G fill:#ffcc99
    style B,C,E,F,H,I fill:#ccffcc
```

## UI上での1対多関係の表示

### 関連リストの表示

```yaml
親レコードページでの表示:
  関連リスト:
    位置: レコード詳細の下部
    内容: 子レコードの一覧
    
  機能:
    - 新規作成ボタン
    - 編集・削除リンク
    - ソート・絞り込み
    - ページネーション
    
カスタマイズ:
  Lightning App Builder:
    - 関連リストコンポーネント
    - 表示項目の選択
    - アクション設定
```

### 関連リストの設定

```mermaid
flowchart TD
    A[ページレイアウト編集] --> B[関連リスト]
    
    B --> C[利用可能な関連リスト]
    B --> D[選択済み関連リスト]
    
    C -->|ドラッグ&ドロップ| D
    
    D --> E[表示設定]
    E --> F[表示項目選択]
    E --> G[ソート順設定]
    E --> H[ボタン設定]
    
    F --> I[最大10項目]
    G --> J[デフォルトソート]
    H --> K[新規・編集ボタン]
    
    style A fill:#ff9999
    style E fill:#ccffcc
```

### モバイルでの表示

```yaml
Salesforceモバイルアプリ:
  関連タブ:
    - スワイプで切り替え
    - 子レコード一覧表示
    
  ナビゲーション:
    - 親から子へ遷移
    - 子から親へ戻る
    
  制限事項:
    - 表示項目数制限
    - アクション制限
```

## 関連

- [Salesforceのオブジェクト間の関連性](2025.08.12.22.25_how_salesforce_objects_relate_each_other.md)
- [Salesforceの標準オブジェクトとレコード種別](2025.08.12.22.03_what_salesforce_standard_objects_by_records.md)
- [Salesforceのシステム監査項目](2025.08.13.06.48_what_salesforce_system_audit_fields.md)
- [Salesforce Help: オブジェクトリレーションシップの概要](https://help.salesforce.com/s/articleView?id=sf.overview_of_custom_object_relationships.htm&type=5)
- [Salesforce Help: 参照関係](https://help.salesforce.com/s/articleView?id=sf.relationships_considerations_lookup.htm&type=5)
- [Salesforce Help: 主従関係](https://help.salesforce.com/s/articleView?id=sf.relationships_considerations_master_detail.htm&type=5)
- [Trailhead: データモデリング](https://trailhead.salesforce.com/ja/content/learn/modules/data_modeling)